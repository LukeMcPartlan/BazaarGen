<!DOCTYPE html> 
<html lang="en">
<head>
  <script>
      // Domain redirect
      if (window.location.hostname === 'bazzargen.com' || 
          window.location.hostname === 'www.bazzargen.com') {
          
          // Build the correct URL
          var correctUrl = 'https://bazaargen.com' + window.location.pathname + window.location.search + window.location.hash;
          
          // Log for debugging
          console.log('Redirecting from:', window.location.href);
          console.log('Redirecting to:', correctUrl);
          
          // Try multiple redirect methods
          try {
              window.location.replace(correctUrl);
          } catch(e) {
              window.location.href = correctUrl;
          }
      }
      
      // Optional: Redirect www.bazaargen.com to bazaargen.com
      if (window.location.hostname === 'www.bazaargen.com') {
          var correctUrl = 'https://bazaargen.com' + window.location.pathname + window.location.search + window.location.hash;
          try {
              window.location.replace(correctUrl);
          } catch(e) {
              window.location.href = correctUrl;
          }
      }
</script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bazaar Card Generator - Create Custom Game Cards | BazaarGen Tool</title>
  
  <!-- SEO Meta Tags -->
  <meta name="description" content="Free online tool to create custom Bazaar content Design items and skills for The Bazaar game." />
  <meta name="keywords" content="Bazaar, Bazaar, BazaarGen, Bazaar Card Generator, card generator, game cards, custom cards, item cards, hero cards, Reynad, The Bazaar, card creator, game tool, free generator, online tool, card design, gaming, TCG, trading card game, card maker, Mak, Vanessa, Pyg, Dooly, game items, passive effects, on use effects, cooldown, ammo, tags, border quality, card customization" />
  <meta name="author" content="Luke Alvarez" />
  <meta name="robots" content="index, follow" />
  <meta name="language" content="English" />
  <meta name="revisit-after" content="7 days" />
  
  <!-- Favicon and Icons -->
  <link rel="icon" type="image/x-icon" href="images/favicon.ico" />
  <link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="images/apple-touch-icon.png" />
  <link rel="manifest" href="site.webmanifest" />
  
  <!-- Open Graph Meta Tags -->
  <meta property="og:title" content="Bazaar Card Generator - Create Custom Game Cards" />
  <meta property="og:description" content="Free online tool to create custom Bazaar content Design items and skills for The Bazaar game." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://Bazaargen.com/" />
  <meta property="og:image" content="https://Bazaargen.com/images/site-preview.png" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />
  <meta property="og:site_name" content="BazaarGen - Bazaar Card Generator" />
  
  <!-- Twitter Card Meta Tags -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Bazaar Card Generator - Create Custom Game Cards" />
  <meta name="twitter:description" content="Free online tool to create custom Bazaar content Design items and skills for The Bazaar game." />
  <meta name="twitter:image" content="https://Bazaargen.com/images/site-preview.png" />
  
  <!-- Additional SEO -->
  <meta name="theme-color" content="#8B7A65" />
  <link rel="canonical" href="https://Bazaargen.com/" />

  

  
  <!-- External Libraries -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      background-color: rgb(139, 122, 101);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Top Navigation Bar Styles */
    .top-nav {
      background: linear-gradient(135deg, rgb(74, 60, 46) 0%, rgb(37, 26, 12) 100%);
      border-bottom: 3px solid rgb(218, 165, 32);
      padding: 0;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .nav-container {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      height: 70px;
    }

    .nav-logo {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 1.8em;
      font-weight: bold;
      color: rgb(251, 225, 183);
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
      text-decoration: none;
      transition: all 0.3s ease;
    }

    .nav-logo:hover {
      color: rgb(218, 165, 32);
      transform: translateY(-1px);
    }

    .nav-logo::before {
      content: "⚔️";
      font-size: 1.2em;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .nav-menu {
      display: flex;
      list-style: none;
      gap: 0;
      margin: 0;
      padding: 0;
    }

    .nav-item {
      position: relative;
    }

    .nav-link {
      display: flex;
      align-items: center;
      padding: 25px 25px;
      color: rgb(201, 175, 133);
      text-decoration: none;
      font-weight: bold;
      font-size: 1.1em;
      text-transform: uppercase;
      letter-spacing: 1px;
      transition: all 0.3s ease;
      position: relative;
      height: 70px;
      border-left: 1px solid rgba(218, 165, 32, 0.2);
    }

    .nav-link:first-child {
      border-left: none;
    }

    .nav-link:hover {
      background: linear-gradient(135deg, rgb(218, 165, 32) 0%, rgb(184, 134, 11) 100%);
      color: rgb(37, 26, 12);
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }

    .nav-link.active {
      background: linear-gradient(135deg, rgb(218, 165, 32) 0%, rgb(255, 215, 0) 100%);
      color: rgb(37, 26, 12);
      box-shadow: inset 0 -3px 0 rgb(184, 134, 11);
    }

    .nav-link::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      width: 0;
      height: 3px;
      background: rgb(255, 215, 0);
      transition: all 0.3s ease;
      transform: translateX(-50%);
    }

    .nav-link:hover::after {
      width: 80%;
    }

    /* Mobile menu styles */
    .nav-toggle {
      display: none;
      flex-direction: column;
      cursor: pointer;
      padding: 5px;
    }

    .nav-toggle span {
      width: 25px;
      height: 3px;
      background: rgb(251, 225, 183);
      margin: 3px 0;
      transition: 0.3s;
      border-radius: 2px;
    }

    @media (max-width: 768px) {
      .nav-menu {
        position: fixed;
        top: 70px;
        left: -100%;
        width: 100%;
        height: calc(100vh - 70px);
        background: linear-gradient(135deg, rgb(74, 60, 46) 0%, rgb(37, 26, 12) 100%);
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
        transition: left 0.3s ease;
        padding-top: 50px;
      }

      .nav-menu.active {
        left: 0;
      }

      .nav-link {
        width: 90%;
        text-align: center;
        padding: 20px;
        margin: 10px 0;
        border: 2px solid rgb(218, 165, 32);
        border-radius: 10px;
        background: rgba(37, 26, 12, 0.5);
        height: auto;
        border-left: 2px solid rgb(218, 165, 32);
      }

      .nav-toggle {
        display: flex;
      }

      .nav-container {
        padding: 0 15px;
      }

      .nav-logo {
        font-size: 1.5em;
      }
    }

    /* Main content styles */
    .main-content {
      flex: 1;
      padding: 2em;
    }

    .page-header {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px 0;
    }

    .page-title {
      color: rgb(251, 225, 183);
      font-size: 3em;
      font-weight: bold;
      text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.7);
      margin-bottom: 10px;
      background: linear-gradient(45deg, rgb(251, 225, 183), rgb(218, 165, 32));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .page-subtitle {
      color: rgb(201, 175, 133);
      font-size: 1.2em;
      font-style: italic;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
    }

    h1 {
      color: rgb(251, 225, 183);
    }

    .input-container {
      background: linear-gradient(135deg, rgb(101, 84, 63) 0%, rgb(89, 72, 51) 100%);
      border: 2px solid rgb(251, 225, 183);
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group.full-width {
      grid-column: 1 / -1;
    }

    .form-label {
      color: rgb(251, 225, 183);
      font-weight: bold;
      margin-bottom: 8px;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-input, .form-select {
      padding: 12px 15px;
      border: 2px solid rgb(74, 60, 46);
      border-radius: 8px;
      background-color: rgb(37, 26, 12);
      color: rgb(251, 225, 183);
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: gold;
      box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.2);
    }

    .form-input::placeholder {
      color: rgb(150, 120, 90);
    }

    .form-button {
      padding: 12px 25px;
      background: linear-gradient(135deg, rgb(218, 165, 32) 0%, rgb(184, 134, 11) 100%);
      border: none;
      border-radius: 8px;
      color: rgb(37, 26, 12);
      font-weight: bold;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-button:hover {
      background: linear-gradient(135deg, rgb(255, 215, 0) 0%, rgb(218, 165, 32) 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .form-button.secondary {
      background: linear-gradient(135deg, rgb(101, 84, 63) 0%, rgb(74, 60, 46) 100%);
      color: rgb(251, 225, 183);
      border: 2px solid rgb(251, 225, 183);
    }

    .form-button.secondary:hover {
      background: linear-gradient(135deg, rgb(74, 60, 46) 0%, rgb(101, 84, 63) 100%);
    }

    .form-button.remove {
      background: linear-gradient(135deg, rgb(180, 60, 60) 0%, rgb(140, 40, 40) 100%);
      color: white;
      border: 2px solid rgb(200, 80, 80);
      padding: 8px 15px;
      font-size: 12px;
      margin-left: 10px;
    }

    .form-button.remove:hover {
      background: linear-gradient(135deg, rgb(200, 80, 80) 0%, rgb(180, 60, 60) 100%);
    }

    .form-button.export {
      background: linear-gradient(135deg, rgb(46, 125, 50) 0%, rgb(27, 94, 32) 100%);
      color: white;
      border: 2px solid rgb(76, 175, 80);
      padding: 8px 15px;
      font-size: 12px;
      margin-left: 5px;
    }

    .form-button.export:hover {
      background: linear-gradient(135deg, rgb(76, 175, 80) 0%, rgb(46, 125, 50) 100%);
    }

    .on-use-effects, .tag-effects {
      background: rgba(37, 26, 12, 0.5);
      border: 1px solid rgb(74, 60, 46);
      border-radius: 8px;
      padding: 15px;
      margin-top: 10px;
    }

    .tag-input-group {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }

    .on-use-input-group {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }

    .on-use-input-group input {
      flex: 1;
    }

    .button-group {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 25px;
      flex-wrap: wrap;
    }

    .export-import-section {
      background: rgba(37, 26, 12, 0.5);
      border: 1px solid rgb(74, 60, 46);
      border-radius: 8px;
      padding: 15px;
      margin-top: 20px;
    }

    .export-import-section h4 {
      color: rgb(251, 225, 183);
      margin: 0 0 15px 0;
      font-size: 16px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .export-import-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .hidden-input {
      display: none;
    }

    .card {
      display: flex;
      align-items: flex-start;
      background-color: rgb(101, 84, 63);
      padding: 1em;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      margin-top: 10px;
      position: relative;
    }

    .card-visual-content {
      display: flex;
      align-items: flex-start;
      width: fit-content;
      position: relative;
      padding: 20px; /* Add padding around the content */
      border-radius: 10px; /* Match the main card styling */
    }

    .card-controls {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 10;
      display: flex;
      gap: 5px;
    }

    .card-delete-btn, .card-export-btn {
      border-radius: 50%;
      width: 30px;
      height: 30px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      border: 2px solid;
    }

    .card-delete-btn {
      background: linear-gradient(135deg, rgb(180, 60, 60) 0%, rgb(140, 40, 40) 100%);
      color: white;
      border-color: rgb(200, 80, 80);
    }

    .card-delete-btn:hover {
      background: linear-gradient(135deg, rgb(200, 80, 80) 0%, rgb(180, 60, 60) 100%);
      transform: scale(1.1);
    }

    .card-export-btn {
      background: linear-gradient(135deg, rgb(46, 125, 50) 0%, rgb(27, 94, 32) 100%);
      color: white;
      border-color: rgb(76, 175, 80);
      position: relative;
    }

    .card-export-btn:hover {
      background: linear-gradient(135deg, rgb(76, 175, 80) 0%, rgb(46, 125, 50) 100%);
      transform: scale(1.1);
    }

    .export-menu {
      position: absolute;
      top: 35px;
      right: 0;
      background: linear-gradient(135deg, rgb(74, 60, 46) 0%, rgb(37, 26, 12) 100%);
      border: 2px solid rgb(218, 165, 32);
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      min-width: 140px;
      z-index: 20;
      display: none;
    }

    .export-menu.show {
      display: block;
    }

    .export-option {
      padding: 10px 15px;
      color: rgb(251, 225, 183);
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 12px;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .export-option:hover {
      background: rgba(218, 165, 32, 0.2);
      color: rgb(218, 165, 32);
    }

    .export-option:first-child {
      border-radius: 6px 6px 0 0;
    }

    .export-option:last-child {
      border-radius: 0 0 6px 6px;
    }

    .card-save-btn {
  background: linear-gradient(135deg, rgb(76, 175, 80) 0%, rgb(46, 125, 50) 100%);
  color: white;
  border-color: rgb(76, 175, 80);
  border-radius: 50%;
  width: 30px;
  height: 30px;
  font-size: 16px;
  font-weight: bold;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  border: 2px solid;
}

.card-save-btn:hover {
  background: linear-gradient(135deg, rgb(129, 199, 132) 0%, rgb(76, 175, 80) 100%);
  transform: scale(1.1);
}

.card-save-btn:disabled {
  background: linear-gradient(135deg, rgb(150, 150, 150) 0%, rgb(120, 120, 120) 100%);
  cursor: not-allowed;
  transform: none;
}

    .image-container {
      border: 3px solid gold;
      padding: 5px;
      margin-right: 50px; /* Increased from 20px to 50px (added 30px) */
      margin-top: 35px; /* Added 35px top margin */
      border-radius: 10px;
      overflow: visible; /* Allow frame to extend outside container */
      display: flex;
      align-items: center;
      justify-content: center;
      height: 150px; /* Fixed height at 150px */
      width: auto;
      flex-shrink: 0;
      background: rgb(74, 60, 46);
      position: relative; /* For frame positioning */
    }

    .image-container img:not(.card-frame img) {
      height: 100%;
      width: auto;
      display: block;
      object-fit: cover;
      object-position: center;
      /* Clip the uploaded image to container bounds */
      clip-path: inset(0);
    }

    .uploaded-image {
      height: 100%;
      width: auto;
      display: block;
      object-fit: cover;
      object-position: center;
      /* Center the image horizontally within its container */
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      min-width: 100%;
      min-height: 100%;
    }

    .image-clip-wrapper {
      position: absolute;
      top: 5px;
      left: 5px;
      right: 5px;
      bottom: 5px;
      overflow: hidden; /* Clips only the uploaded image */
      border-radius: 7px; /* Match container radius minus padding */
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .card-frame {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 110%; /* 10% bigger than container */
      height: 110%; /* 10% bigger than container */
      transform: translate(-50%, -50%); /* Center the frame */
      pointer-events: none;
      z-index: 2;
      //border: 2px solid blue; /* Debug border */
      box-sizing: border-box;
    }

    .card-frame img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      object-position: center;
      display: block;
    }

    .card-content {
      position: relative;
      display: flex;
      flex-direction: column;
      border: 3px solid gold;
      border-radius: 10px;
      max-width: 400px;
      min-width: 300px;
      width: fit-content;
      background: radial-gradient(ellipse at center, rgb(60, 45, 30) 0%, rgb(45, 35, 22) 40%, rgb(25, 18, 10) 100%) !important;
    }

    .card-wrapper {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }

    .tags-container {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-bottom: 5px;
      padding: 0;
      background: transparent;
      width: 300px; /* Fixed width at 300px */
    }

    .item-tag {
      background-color: rgba(0, 0, 139, 0.5);
      color: rgb(152, 168, 254);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8em;
      font-weight: bold;
      font-family: Arial, sans-serif;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
      border: 1px solid rgba(152, 168, 254, 0.3);
    }

    .text-section {
      border-top: 2px solid gold;
      border-bottom: 2px solid gold;
      padding: 10px;
      color: rgb(251, 225, 183);
      text-shadow: 1px 1px 2px black;
      font-family: Impact, 'Arial Black', 'Franklin Gothic Bold', Arial, sans-serif;
    }

    .hero-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: relative;
    }

    .item-title {
      font-size: 2em;
    }

    .hero-header img {
      max-width: 40px;
      height: auto;
      border-radius: 5px;
      margin-left: 10px;
    }

    .on-use-line {
      display: flex;
      align-items: center;
      margin-bottom: 4px;
      margin-left: 40px;
    }

    .on-use-section {
      padding-left: 20px;
    }

    .on-use-line img {
      width: 16px;
      height: 18px;
      margin-right: 8px;
    }

    .cooldown-section {
      left: -30px;
      border-radius: 50%;
      border: 3px solid rgb(52, 45, 68);
      width: 50px;
      height: 50px;
      padding: 0;
      font-size: 1.2em; /* Reduced from 1.4em */
      line-height: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: white;
      background-color: #222;
      position: absolute;
      z-index: 1;
      overflow: visible; /* Allow border to overflow */
    }

    .cooldown-section span {
      display: block;
      position: relative;
      z-index: 1;
    }

    .cooldown-border {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 130%;
      height: 130%;
      transform: translate(calc(-50% + 2px), -50%);
      pointer-events: none;
      z-index: 0;
    }

    .cooldown-section span {
      display: block;
    }

    .cooldown-section .sec-text {
      font-size: 0.6em;
      color: rgb(217, 149, 81);
    }

    .ammo-section {
      right: -30px;
      border-radius: 10px;
      border: 3px solid silver;
      padding: 5px 10px;
      font-size: 0.9em;
      height: auto;
      width: auto;
      position: absolute;
      z-index: 1;
      background-color: rgb(37, 26, 12);
      color: rgb(254, 142, 0);
      font-weight: bold;
      font-family: Impact, 'Arial Black', 'Franklin Gothic Bold', Arial, sans-serif;
      text-shadow: 1px 1px 2px black;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 3px;
    }

    .ammo-section img {
      width: 20px;
      height: 20px;
    }

    .scaling-values-container {
      position: absolute;
      top: -15px; /* Position at top border of image container */
      left: 50%; /* Center the container */
      transform: translateX(-50%); /* Center horizontally */
      width: 150%; /* 50% wider than the image container */
      display: flex;
      gap: 2px; /* Reduced gap between elements */
      z-index: 10;
      flex-wrap: wrap;
      justify-content: center;
      padding: 0 5px; /* Small padding from container edges */
    }

    .scaling-value {
      background-color: #333;
      color: white;
      padding: 6px 8px; /* Reduced horizontal padding */
      border-radius: 3px; /* Much smaller radius for more squared appearance */
      font-size: 11px;
      font-weight: bold;
      font-family: Arial, sans-serif;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.3);
      min-width: 28px; /* Reduced minimum width */
      text-align: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      flex: 1; /* Allow elements to grow and fill available space */
      max-width: 45px; /* Reduced max width to ensure 3+ fit across */
    }

    .scaling-value.heal {
      background-color: rgb(143, 234, 49);
    }

    .scaling-value.regen {
      background-color: rgb(100, 255, 60);
    }

    .scaling-value.shield {
      background-color: rgb(245, 208, 33);
    }

    .scaling-value.damage {
      background-color: rgb(244, 82, 60);
    }

    .scaling-value.poison {
      background-color: rgb(13, 190, 79);
    }

    .scaling-value.burn {
      background-color: rgb(253, 146, 63);
    }

    .error {
      color: red;
      font-weight: bold;
      margin-top: 10px;
    }

    .success {
      color: rgb(143, 234, 49);
      font-weight: bold;
      margin-top: 10px;
    }

    .shortcuts-help {
      background: rgba(37, 26, 12, 0.7);
      border: 1px solid rgb(74, 60, 46);
      border-radius: 8px;
      padding: 15px;
      margin-top: 10px;
      color: rgb(201, 175, 133);
      font-size: 12px;
    }

    .shortcuts-help h4 {
      color: rgb(251, 225, 183);
      margin: 0 0 10px 0;
      font-size: 14px;
    }

    .shortcuts-help .shortcut-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 8px;
    }

    .shortcuts-help .shortcut-item {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 2px 0;
    }

    .shortcuts-help .shortcut-key {
      color: rgb(218, 165, 32);
      font-weight: bold;
    }

    .keyword-icon {
      width: 16px;
      height: 18px;
      display: inline;
      vertical-align: middle;
      margin: 0 2px;
    }

    .keyword-preview {
      width: 16px;
      height: 18px;
      display: inline;
      vertical-align: middle;
    }

    /* Footer Styles */
    .footer {
      background: linear-gradient(135deg, rgb(74, 60, 46) 0%, rgb(89, 72, 51) 100%);
      border-top: 3px solid rgb(251, 225, 183);
      margin-top: 40px;
      padding: 30px 0;
      text-align: center;
      box-shadow: 0 -4px 15px rgba(0, 0, 0, 0.3);
    }

    .footer-content {
      max-width: 800px;
      margin: 0 auto;
      padding: 0 20px;
    }

    .footer-title {
      color: rgb(251, 225, 183);
      font-size: 1.5em;
      font-weight: bold;
      margin-bottom: 15px;
      text-transform: uppercase;
      letter-spacing: 1px;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
    }

    .footer-description {
      color: rgb(201, 175, 133);
      font-size: 1em;
      margin-bottom: 20px;
      line-height: 1.6;
    }

    .footer-links {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .footer-link {
      color: rgb(218, 165, 32);
      text-decoration: none;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      transition: all 0.3s ease;
      padding: 8px 15px;
      border: 2px solid transparent;
      border-radius: 5px;
    }

    .footer-link:hover {
      color: rgb(255, 215, 0);
      border-color: rgb(255, 215, 0);
      background: rgba(255, 215, 0, 0.1);
      transform: translateY(-2px);
    }

    .footer-divider {
      height: 2px;
      background: linear-gradient(90deg, transparent 0%, rgb(218, 165, 32) 50%, transparent 100%);
      margin: 20px 0;
    }

    .footer-copyright {
      color: rgb(150, 120, 90);
      font-size: 0.9em;
      font-style: italic;
    }

    .footer-contact {
      color: rgb(150, 120, 90);
      font-size: 0.9em;
      margin-top: 8px;
    }

    .footer-version {
      color: rgb(101, 84, 63);
      font-size: 0.8em;
      margin-top: 10px;
    }

    /* Keyword Text Styling */
    .key-text {
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
      font-weight: bold;
    }

    @media (max-width: 600px) {
      .footer-links {
        flex-direction: column;
        align-items: center;
        gap: 15px;
      }

      .main-content {
        padding: 1em;
      }

      .page-title {
        font-size: 2em;
      }

      .form-grid {
        grid-template-columns: 1fr;
      }

      .export-import-buttons {
        flex-direction: column;
      }

      .card-controls {
        flex-direction: column;
        gap: 3px;
      }
    }

      .preview-container {
          border: 1px solid #ccc;
          padding: 10px;
          margin-bottom: 20px;
          background: #f8f8ff;
      }

  </style>
</head>
<body>
  <!-- Top Navigation -->
  <nav class="top-nav">
    <div class="nav-container">
      <a href="#" class="nav-logo">BazaarGen</a>
      
      <ul class="nav-menu" id="nav-menu">
        <li class="nav-item">
          <a href="#" class="nav-link active" data-page="items">Items</a>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link" data-page="skills">Skills</a>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link" data-page="contests">Contests</a>
        </li>
      </ul>
       <!-- Google sign in stuff-->
                         <div class="nav-actions">
              <!-- Google Sign-In Button (shown when not signed in) -->
              <div id="google-signin-button"></div>
          
              <!-- User Info (shown when signed in) -->
              <div class="user-info" id="user-info" style="display: none; align-items: center; gap: 10px;">
                  <span class="user-alias" id="user-alias" style="font-weight: 500; color: #333; cursor: pointer;" onclick="editAlias()" title="Click to edit alias"></span>
                  <button class="sign-out-btn" onclick="signOut()" style="background: none; border: 1px solid #ddd; padding: 6px 12px; border-radius: 4px; cursor: pointer; color: #666; font-size: 14px;">Sign Out</button>
              </div>
          </div>
          
          <!-- 3. Alias Creation Modal -->
          <div id="alias-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
              <div style="background: white; padding: 30px; border-radius: 8px; max-width: 400px; width: 90%; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.15);">
                  <h2 id="alias-modal-title" style="margin: 0 0 10px 0; color: #333;">Welcome to BazaarGen!</h2>
                  <p id="alias-modal-description" style="color: #666; margin: 0 0 20px 0;">Choose an alias to display on the site</p>
                  
                  <input type="text" id="alias-input" placeholder="Enter your alias" 
                         style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 4px; font-size: 16px; margin-bottom: 10px; box-sizing: border-box;">
                  
                  <div id="alias-error" style="color: #d32f2f; font-size: 14px; margin-bottom: 15px; min-height: 20px;"></div>
                  
                  <div style="display: flex; gap: 10px; justify-content: center;">
                      <button id="alias-cancel-btn" onclick="cancelAliasCreation()" 
                              style="padding: 10px 20px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer; color: #666;">
                          Cancel
                      </button>
                      <button id="alias-save-btn" onclick="saveAlias()" 
                              style="padding: 10px 20px; border: none; background: #007bff; color: white; border-radius: 4px; cursor: pointer;">
                          Save Alias
                      </button>
                  </div>
              </div>
          </div>
      <!--end of google stuff-->
    </div>

      <div class="nav-toggle" id="nav-toggle">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>
  </nav>

  <div class="main-content">
      <!-- Page Header -->
      <div class="page-header">
          <h1 class="page-title">Bazaar Card Generator</h1>
      </div>

      <div id="previewContainer"></div>
      <br />

      <div class="input-container">
          <div class="form-grid">
              <div class="form-group full-width">
                  <label class="form-label">Card Image</label>
                  <input type="file" id="imageInput" accept="image/*" class="form-input" />
              </div>

              <div class="form-group">
                  <label class="form-label">Item Name</label>
                  <input type="text" id="itemNameInput" placeholder="Enter item name" class="form-input" />
              </div>

              <div class="form-group">
                  <label class="form-label">Hero</label>
                  <select id="heroSelect" class="form-select">
                      <option value="Neutral" selected>Neutral</option>
                      <option value="Mak">Mak</option>
                      <option value="Vanessa">Vanessa</option>
                      <option value="Pyg">Pyg</option>
                      <option value="Dooly">Dooly</option>
                      <option value="Stelle">Stelle</option>
                      <option value="Jules">Jules</option>
                      <option value="Vampire"> Vampire</option>
                  </select>
              </div>

              <div class="form-group">
                  <label class="form-label">Cooldown (seconds)</label>
                  <input type="text" id="cooldownInput" placeholder="e.g. 7.0" class="form-input" />
              </div>

              <div class="form-group">
                  <label class="form-label">Ammo Count</label>
                  <input type="text" id="ammoInput" placeholder="e.g. 3" class="form-input" />
              </div>

              <div class="form-group">
                  <label class="form-label">Item Size</label>
                  <select id="itemSizeSelect" class="form-select">
                      <option value="Small">Small</option>
                      <option value="Medium" selected>Medium</option>
                      <option value="Large">Large</option>
                  </select>
              </div>

              <div class="form-group">
                  <label class="form-label">Item Rarity</label>
                  <select id="borderSelect" class="form-select">
                      <option value="bronze">Bronze</option>
                      <option value="silver">Silver</option>
                      <option value="gold" selected>Gold</option>
                      <option value="diamond">Diamond</option>
                      <option value="legendary">Legendary</option>
                  </select>
              </div>

              <div class="form-group full-width">
                  <label class="form-label">Passive Effects</label>
                  <input type="text" id="passiveInput" placeholder="Enter passive effect description" class="form-input" />
              </div>
          </div>

          <div class="tag-effects">
              <label class="form-label">Above Card Values</label>
              <div class="form-grid">
                  <div class="form-group">
                      <label class="form-label">Heal</label>
                      <input type="text" id="healScalingInput" placeholder="N/A" class="form-input" />
                  </div>
                  <div class="form-group">
                      <label class="form-label">Regen</label>
                      <input type="text" id="regenScalingInput" placeholder="N/A" class="form-input" />
                  </div>
                  <div class="form-group">
                      <label class="form-label">Shield</label>
                      <input type="text" id="shieldScalingInput" placeholder="N/A" class="form-input" />
                  </div>
                  <div class="form-group">
                      <label class="form-label">Damage</label>
                      <input type="text" id="damageScalingInput" placeholder="N/A" class="form-input" />
                  </div>
                  <div class="form-group">
                      <label class="form-label">Poison</label>
                      <input type="text" id="poisonScalingInput" placeholder="N/A" class="form-input" />
                  </div>
                  <div class="form-group">
                      <label class="form-label">Burn</label>
                      <input type="text" id="burnScalingInput" placeholder="N/A" class="form-input" />
                  </div>
              </div>
          </div>

          <div class="tag-effects">
              <label class="form-label">Additional Tags</label>
              <div id="tagInputs"></div>
              <button type="button" onclick="addTagInput()" class="form-button secondary" style="margin-top: 10px;">Add Tag</button>
          </div>

          <div class="on-use-effects">
              <label class="form-label">On Use Effects</label>
              <div id="onUseInputs"></div>
              <button type="button" onclick="addOnUseInput()" class="form-button secondary" style="margin-top: 10px;">Add On Use Effect</button>
          </div>

          <div class="shortcuts-help">
              <h4>🎮 Keyword Shortcuts - Type these in text boxes:</h4>
              <div class="shortcut-grid">
                  <div class="shortcut-item"><span class="shortcut-key">/s</span> <img src="images/KeyText/slow.png" alt="slow" class="keyword-preview"> <span style="color: rgb(203, 159, 110); font-weight: bold;" class="key-text">slow</span></div>
                  <div class="shortcut-item"><span class="shortcut-key">/h</span> <img src="images/KeyText/haste.png" alt="haste" class="keyword-preview"> <span style="color: rgb(0, 235, 195); font-weight: bold;" class="key-text">haste</span></div>
                  <div class="shortcut-item"><span class="shortcut-key">/he</span> <img src="images/KeyText/heal.png" alt="heal" class="keyword-preview"> <span style="color: rgb(143, 234, 49); font-weight: bold;" class="key-text">heal</span></div>
                  <div class="shortcut-item"><span class="shortcut-key">/r</span> <img src="images/KeyText/regen.png" alt="regen" class="keyword-preview"> <span style="color: rgb(143, 234, 49); font-weight: bold;" class="key-text">regen</span></div>
                  <div class="shortcut-item"><span class="shortcut-key">/p</span> <img src="images/KeyText/poison.png" alt="poison" class="keyword-preview"> <span style="color: rgb(13, 190, 79); font-weight: bold;" class="key-text">poison</span></div>
                  <div class="shortcut-item"><span class="shortcut-key">/b</span> <img src="images/KeyText/burn.png" alt="burn" class="keyword-preview"> <span style="color: rgb(253, 146, 63); font-weight: bold;" class="key-text">burn</span></div>
                  <div class="shortcut-item"><span class="shortcut-key">/c</span> <img src="images/KeyText/charge.png" alt="charge" class="keyword-preview"> <span style="color: rgb(0, 235, 195); font-weight: bold;" class="key-text">charge</span></div>
                  <div class="shortcut-item"><span class="shortcut-key">/cd</span> <img src="images/KeyText/cooldown.png" alt="cooldown" class="keyword-preview"> <span style="color: rgb(0, 235, 195); font-weight: bold;" class="key-text">cooldown</span></div>
                  <div class="shortcut-item"><span class="shortcut-key">/cr</span> <img src="images/KeyText/crit.png" alt="crit" class="keyword-preview"> <span style="color: rgb(244, 82, 60); font-weight: bold;" class="key-text">crit</span></div>
                  <div class="shortcut-item"><span class="shortcut-key">/d</span> <img src="images/KeyText/damage.png" alt="damage" class="keyword-preview"> <span style="color: rgb(244, 82, 60); font-weight: bold;" class="key-text">damage</span></div>
                  <div class="shortcut-item"><span class="shortcut-key">/de</span> <img src="images/KeyText/destroy.png" alt="destroy" class="keyword-preview"> <span style="color: rgb(198, 44, 66); font-weight: bold;" class="key-text">destroy</span></div>
                  <div class="shortcut-item"><span class="shortcut-key">/f</span> <img src="images/KeyText/freeze.png" alt="freeze" class="keyword-preview"> <span style="color: rgb(63, 200, 247); font-weight: bold;" class="key-text">freeze</span></div>
                  <div class="shortcut-item"><span class="shortcut-key">/l</span> <img src="images/KeyText/lifesteal.png" alt="lifesteal" class="keyword-preview"> <span style="color: rgb(181, 56, 115); font-weight: bold;" class="key-text">lifesteal</span></div>
                  <div class="shortcut-item"><span class="shortcut-key">/v</span> <img src="images/KeyText/value.png" alt="value" class="keyword-preview"> <span style="color: rgb(244, 208, 33); font-weight: bold;" class="key-text">value</span></div>
                  <div class="shortcut-item"><span class="shortcut-key">/t</span> <img src="images/KeyText/transform.png" alt="transform" class="keyword-preview"> <span style="color: rgb(90, 230, 233); font-weight: bold;" class="key-text">transform</span></div>
                  <div class="shortcut-item"><span class="shortcut-key">/sh</span> <img src="images/KeyText/sheild.png" alt="sheild" class="keyword-preview"> <span style="color: rgb(245, 208, 33); font-weight: bold;" class="key-text">sheild</span></div>
                  <div class="shortcut-item"><span class="shortcut-key">/mh</span> <img src="images/KeyText/maxhealth.png" alt="maxhealth" class="keyword-preview"> <span style="color: rgb(143, 234, 49); font-weight: bold;" class="key-text">maxhealth</span></div>
              </div>
          </div>

          <div class="button-group">
              <button onclick="createCard()" class="form-button">Generate Card</button>
              <button onclick="clearAllCards()" class="form-button secondary">Clear All Cards</button>
          </div>

          <div class="export-import-section">
              <h4>💾 Export & Import</h4>
              <div class="export-import-buttons">
                  <button onclick="exportAllCardsAsData()" class="form-button export">Export All as Data</button>
                  <button onclick="exportAllCardsAsPNG()" class="form-button export">Export All as PNG</button>
                  <button onclick="triggerImport()" class="form-button secondary">Import Card Data</button>
              </div>
              <input type="file" id="importInput" accept=".json" class="hidden-input" onchange="importCardData(event)" />
          </div>

          <div id="errorContainer"></div>
      </div>

      <div id="outputContainer"></div>
  </div>

  <!-- Footer -->
  <footer class="footer">
    <div class="footer-content">
      <div class="footer-title">⚔️ Bazaar Card Generator ⚔️</div>
      <div class="footer-description">
        Bring your ideas to life. Shoutout to Reynad for tearing this masterpeice from the void. 
      </div>
      
      <div class="footer-links">
        <a href="https://github.com/LukeMcPartlan/BazaarGen" class="footer-link">📜 Documentation</a>
        <a href="updates.html" class="footer-link">🛡️ Updates</a>
        <a href="skills.html" class="footer-link">⚡ Skills</a>
        <a href="https://www.reddit.com/r/PlayTheBazaar/" class="footer-link">🏰 Community</a>
      </div>
      
      <div class="footer-divider"></div>
      
      <div class="footer-copyright">
        © 2025 Luke Alvarez Bazaar Generator
      </div>
      <div class="footer-contact">
        Report bugs to Lukemcp45@gmail.com . Zelle me a coffe at the same email!
      </div>
      <div class="footer-version">
        Version 1.0 | Built for Bazaar fans by Bazaar fans
      </div>
    </div>
  </footer>

  <!-- Hidden SEO Content -->
  <div style="display: none; visibility: hidden;">
    <h2>Bazaar Card Generator Keywords</h2>
    <p>BazaarGen, Bazaar Generator, Bazaar Card Maker, The Bazaar Game Tool, Custom Card Creator, Online Card Generator, Free Card Maker, Game Card Designer, TCG Card Generator, Trading Card Game Tool, Bazaar Item Cards, Hero Card Generator, Effect Card Creator, Cooldown Card Generator, Ammo Card Maker, Tag Card System, Border Quality Cards, Passive Effect Generator, On Use Effect Creator, Mak Cards, Vanessa Cards, Pyg Cards, Dooly Cards, Neutral Cards, Small Medium Large Items, Bronze Silver Gold Diamond Legendary Borders, Reynad Game Tools, The Bazaar Fan Tools, Card Design Software, Web Based Card Generator, Mobile Card Creator, Responsive Card Maker, Gaming Tools Online, Card Customization Tool, Professional Card Design, Game Development Tools, Indie Game Tools, Card Game Assets, Digital Card Creator, Virtual Card Maker, Interactive Card Generator, Real Time Card Preview, Drag Drop Card Creator, Upload Image Cards, Custom Text Cards, Keyword Highlighting, Color Coded Effects, Card Template Generator, Game Prototype Tools, Playtesting Cards, Community Card Sharing, Card Export Tool, Print Ready Cards, High Quality Card Generator, User Friendly Interface, Intuitive Card Design, Fast Card Creation, Unlimited Card Generation, No Download Required, Browser Based Tool, Cross Platform Generator, Modern Card Design, Stylish Card Templates, Game Ready Cards, Professional Gaming Tools</p>
    
    <h3>Related Game Terms</h3>
    <p>Auto Battler, Strategy Game, Deck Building, Item Management, Hero Abilities, Game Mechanics, Turn Based, Real Time Strategy, Competitive Gaming, Esports Tools, Streaming Tools, Content Creation, Game Modding, Fan Art Tools, Community Tools, Game Assets, Digital Art, Card Art, Fantasy Gaming, RPG Elements, Character Cards, Equipment Cards, Spell Cards, Ability Cards, Status Effects, Game Balance, Meta Gaming, Tier Lists, Strategy Guides, Tutorials, How To Guides, Gaming Community, Reddit Gaming, Discord Tools, Twitch Tools, YouTube Gaming</p>
    
    <h4>Technical Keywords</h4>
    <p>HTML5 Card Generator, CSS3 Styling, JavaScript Interactive Tool, Responsive Web Design, Mobile Friendly Generator, Canvas Based Tool, SVG Graphics, Image Processing, File Upload Tool, Client Side Processing, No Server Required, Offline Capable, Progressive Web App, Modern Web Standards, Cross Browser Compatible, Fast Loading Tool, Optimized Performance, Memory Efficient, Touch Friendly Interface, Keyboard Shortcuts, Accessibility Features, Screen Reader Compatible, High DPI Support, Retina Display Ready</p>
  </div>

  <script>
    // Store all cards data for export/import
    let cardsData = [];

    // Navigation functionality
    document.addEventListener('DOMContentLoaded', function() {
      const navToggle = document.getElementById('nav-toggle');
      const navMenu = document.getElementById('nav-menu');
      const navLinks = document.querySelectorAll('.nav-link');

      // Toggle mobile menu
      navToggle.addEventListener('click', function() {
        navMenu.classList.toggle('active');
      });

      // Handle navigation clicks
      navLinks.forEach(link => {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          
          const page = this.getAttribute('data-page');
          
          // Handle external navigation
          if (page === 'skills') {
            window.location.href = 'skills.html';
            return;
          }
          
          // Remove active class from all links
          navLinks.forEach(l => l.classList.remove('active'));
          
          // Add active class to clicked link
          this.classList.add('active');
          
          // Close mobile menu
          navMenu.classList.remove('active');
          
          // Handle page navigation
          handlePageNavigation(page);
        });
      });

      // Close mobile menu when clicking outside
      document.addEventListener('click', function(e) {
        if (!navToggle.contains(e.target) && !navMenu.contains(e.target)) {
          navMenu.classList.remove('active');
        }
      });

      // Close export menus when clicking outside
      document.addEventListener('click', function(e) {
        if (!e.target.closest('.card-export-btn') && !e.target.closest('.export-menu')) {
          document.querySelectorAll('.export-menu').forEach(menu => {
            menu.classList.remove('show');
          });
        }
      });
    });

    function handlePageNavigation(page) {
      // This is where you would handle different page content
      // For now, we'll just update the page title
      const pageTitle = document.querySelector('.page-title');
      
      switch(page) {
        case 'items':
          pageTitle.textContent = 'Bazaar Card Generator';
          break;
        case 'skills':
          pageTitle.textContent = 'Skill Generator';
          break;
        case 'contests':
          pageTitle.textContent = 'Community Contests';
          break;
      }
    }

    // Define keyword colors and styling rules
    const keywordRules = {
      'slow': { color: 'rgb(203, 159, 110)' },
      'haste': { color: 'rgb(0, 235, 195)' },
      'charge': { color: 'rgb(0, 235, 195)' },
      'cooldown': { color: 'rgb(0, 235, 195)' },
      'heal': { color: 'rgb(143, 234, 49)' },
      'regen': { color: 'rgb(143, 234, 49)' },
      'poison': { color: 'rgb(13, 190, 79)' },
      'burn': { color: 'rgb(253, 146, 63)' },
      'crit': { color: 'rgb(244, 82, 60)' },
      'damage': { color: 'rgb(244, 82, 60)' },
      'freeze': { color: 'rgb(63, 200, 247)' },
      'lifesteal': { color: 'rgb(181, 56, 115)' },
      'value': { color: 'rgb(244, 208, 33)' },
      'destroy': { color: 'rgb(198, 44, 66)' },
      'transform': { color: 'rgb(90, 230, 233)' },
      'sheild': { color: 'rgb(245, 208, 33)' },
    };

   function processKeywordText(text) {
      if (!text || typeof text !== 'string') return text;
        
      let processedText = text;
        
        // Process LONGER patterns FIRST to avoid conflicts
        processedText = processedText.replace(/\/cd/g, '[COOLDOWN_ICON]');  // Process /cd before /c
        processedText = processedText.replace(/\/cr/g, '[CRIT_ICON]');      // Process /cr before /c
        processedText = processedText.replace(/\/he/g, '[HEAL_ICON]');      // Process /he before /h
        processedText = processedText.replace(/\/sh/g, '[SHEILD_ICON]');    // Process /sh before /s
        processedText = processedText.replace(/\/mh/g, '[MAXHEALTH_ICON]'); // Process /mh before /h
        processedText = processedText.replace(/\/de/g, '[DESTROY_ICON]');   // Process /de before /d
        
        // Then process single-letter patterns
        processedText = processedText.replace(/\/s/g, '[SLOW_ICON]');
        processedText = processedText.replace(/\/h/g, '[HASTE_ICON]');
        processedText = processedText.replace(/\/r/g, '[REGEN_ICON]');
        processedText = processedText.replace(/\/p/g, '[POISON_ICON]');
        processedText = processedText.replace(/\/b/g, '[BURN_ICON]');
        processedText = processedText.replace(/\/c/g, '[CHARGE_ICON]');
        processedText = processedText.replace(/\/d/g, '[DAMAGE_ICON]');
        processedText = processedText.replace(/\/f/g, '[FREEZE_ICON]');
        processedText = processedText.replace(/\/l/g, '[LIFESTEAL_ICON]');
        processedText = processedText.replace(/\/v/g, '[VALUE_ICON]');
        processedText = processedText.replace(/\/t/g, '[TRANSFORM_ICON]');
      
      // Create a regex pattern that matches all keywords (case insensitive)
      const keywords = Object.keys(keywordRules);
      const pattern = new RegExp(`\\b(${keywords.join('|')})\\b`, 'gi');
      
      // Replace each keyword with styled span
      processedText = processedText.replace(pattern, (match) => {
        const lowerMatch = match.toLowerCase();
        const rule = keywordRules[lowerMatch];
        if (rule) {
          return `<span style="color: ${rule.color}; font-weight: bold;" class="key-text" data-keyword="${lowerMatch}">${match}</span>`;
        }
        return match;
      });
      
      // Finally, replace all placeholders with actual images
      processedText = processedText.replace(/\[SLOW_ICON\]/g, '<img src="images/KeyText/slow.png" alt="slow" class="keyword-icon">');
      processedText = processedText.replace(/\[HASTE_ICON\]/g, '<img src="images/KeyText/haste.png" alt="haste" class="keyword-icon">');
      processedText = processedText.replace(/\[HEAL_ICON\]/g, '<img src="images/KeyText/heal.png" alt="heal" class="keyword-icon">');
      processedText = processedText.replace(/\[REGEN_ICON\]/g, '<img src="images/KeyText/regen.png" alt="regen" class="keyword-icon">');
      processedText = processedText.replace(/\[POISON_ICON\]/g, '<img src="images/KeyText/poison.png" alt="poison" class="keyword-icon">');
      processedText = processedText.replace(/\[BURN_ICON\]/g, '<img src="images/KeyText/burn.png" alt="burn" class="keyword-icon">');
      processedText = processedText.replace(/\[CHARGE_ICON\]/g, '<img src="images/KeyText/charge.png" alt="charge" class="keyword-icon">');
      processedText = processedText.replace(/\[COOLDOWN_ICON\]/g, '<img src="images/KeyText/cooldown.png" alt="cooldown" class="keyword-icon">');
      processedText = processedText.replace(/\[CRIT_ICON\]/g, '<img src="images/KeyText/crit.png" alt="crit" class="keyword-icon">');
      processedText = processedText.replace(/\[DAMAGE_ICON\]/g, '<img src="images/KeyText/damage.png" alt="damage" class="keyword-icon">');
      processedText = processedText.replace(/\[DESTROY_ICON\]/g, '<img src="images/KeyText/destroy.png" alt="destroy" class="keyword-icon">');
      processedText = processedText.replace(/\[FREEZE_ICON\]/g, '<img src="images/KeyText/freeze.png" alt="freeze" class="keyword-icon">');
      processedText = processedText.replace(/\[LIFESTEAL_ICON\]/g, '<img src="images/KeyText/lifesteal.png" alt="lifesteal" class="keyword-icon">');
      processedText = processedText.replace(/\[VALUE_ICON\]/g, '<img src="images/KeyText/value.png" alt="value" class="keyword-icon">');
      processedText = processedText.replace(/\[TRANSFORM_ICON\]/g, '<img src="images/KeyText/transform.png" alt="transform" class="keyword-icon">');
      processedText = processedText.replace(/\[SHEILD_ICON\]/g, '<img src="images/KeyText/sheild.png" alt="sheild" class="keyword-icon">');
      processedText = processedText.replace(/\[MAXHEALTH_ICON\]/g, '<img src="images/KeyText/maxhealth.png" alt="maxhealth" class="keyword-icon">');
      return processedText;
    }

    function addTagInput() {
      const container = document.getElementById("tagInputs");
      
      const inputGroup = document.createElement("div");
      inputGroup.className = "tag-input-group";
      
      const input = document.createElement("input");
      input.type = "text";
      input.placeholder = "Enter tag text";
      input.className = "form-input";
      
      const removeButton = document.createElement("button");
      removeButton.type = "button";
      removeButton.textContent = "Remove";
      removeButton.className = "form-button remove";
      removeButton.onclick = function() {
        container.removeChild(inputGroup);
      };
      
      inputGroup.appendChild(input);
      inputGroup.appendChild(removeButton);
      container.appendChild(inputGroup);
    }

    function addOnUseInput() {
      const container = document.getElementById("onUseInputs");
      
      const inputGroup = document.createElement("div");
      inputGroup.className = "on-use-input-group";
      
      const input = document.createElement("input");
      input.type = "text";
      input.placeholder = "Enter on use effect description";
      input.className = "form-input";
      
      const removeButton = document.createElement("button");
      removeButton.type = "button";
      removeButton.textContent = "Remove";
      removeButton.className = "form-button remove";
      removeButton.onclick = function() {
        container.removeChild(inputGroup);
      };
      
      inputGroup.appendChild(input);
      inputGroup.appendChild(removeButton);
      container.appendChild(inputGroup);
    }

    function getBorderColor(value) {
      switch(value) {
        case 'bronze': return 'rgb(205, 127, 50)';
        case 'silver': return 'silver';
        case 'gold': return 'gold';
        case 'diamond': return 'rgb(185, 242, 255)';
        case 'legendary': return 'rgb(124, 46, 44)';
        default: return 'gold';
      }
    }

    function getFrameFilename(quality, size) {
      // Convert size to frame naming convention
      const sizeMap = {
        'Small': 's',
        'Medium': 'm', 
        'Large': 'l'
      };
      
      const frameSize = sizeMap[size] || 'm';
      const frameQuality = quality.toLowerCase();
      
      return `images/frames/${frameQuality}_${frameSize}_frame.png`;
    }

    function createFrameElement(quality, size) {
      const frameDiv = document.createElement("div");
      frameDiv.className = "card-frame";
      
      const frameImg = document.createElement("img");
      frameImg.src = getFrameFilename(quality, size);
      frameImg.alt = `${quality} ${size} frame`;
      frameImg.onerror = function() {
        console.warn(`Frame not found: ${this.src}`);
        frameDiv.style.display = 'none'; // Hide if frame image fails to load
      };
      
      frameDiv.appendChild(frameImg);
      return frameDiv;
    }

    function getCooldownBorderFilename(quality) {
      // Convert quality to proper case for filename
      const qualityMap = {
        'bronze': 'Bronze',
        'silver': 'silver',
        'gold': 'gold',
        'diamond': 'diamond',
        'legendary': 'Legendary'
      };
      
      const mappedQuality = qualityMap[quality.toLowerCase()] || 'gold';
      return `images/cooldown/${mappedQuality}_cooldown.png`;
    }

    function createCooldownBorderElement(quality) {
      const borderDiv = document.createElement("div");
      borderDiv.className = "cooldown-border";
      borderDiv.style.cssText = `
        position: absolute;
        top: 50%;
        left: 50%;
        width: 130%;
        height: 130%;
        transform: translate(calc(-50% + 2px), -50%);
        pointer-events: none;
        z-index: 0;
        background-image: url('${getCooldownBorderFilename(quality)}');
        background-size: 100% 100%;
        background-repeat: no-repeat;
        background-position: center;
      `;
      
      // Add error handling by trying to load the image first
      const testImg = new Image();
      testImg.onload = function() {
        // Image loaded successfully, background will display
      };
      testImg.onerror = function() {
        console.warn(`Cooldown border not found: ${getCooldownBorderFilename(quality)}`);
        borderDiv.style.display = 'none';
      };
      testImg.src = getCooldownBorderFilename(quality);
      
      return borderDiv;
    }

    function createScalingValuesContainer(scalingData) {
      const container = document.createElement("div");
      container.className = "scaling-values-container";
      
      const scalingTypes = ['heal', 'regen', 'shield', 'damage', 'poison', 'burn'];
      
      scalingTypes.forEach(type => {
        const value = scalingData[type];
        if (value && value.trim()) {
          const scalingElement = document.createElement("div");
          scalingElement.className = `scaling-value ${type}`;
          scalingElement.textContent = value.trim();
          container.appendChild(scalingElement);
        }
      });
      
      return container;
    }

    function formatCooldown(cooldownValue) {
      if (!cooldownValue.trim()) return '';
      
      const num = parseFloat(cooldownValue);
      if (isNaN(num)) {
        throw new Error('Cooldown must be a valid number');
      }
      
      // If it's a whole number, add .0
      if (num % 1 === 0) {
        return num.toFixed(1);
      }
      
      // If it has decimals, remove trailing zeros but keep at least one decimal place
      let formatted = num.toString();
      if (formatted.includes('.')) {
        // Remove trailing zeros
        formatted = formatted.replace(/0+$/, '');
        // If we removed all decimal places, add back one zero
        if (formatted.endsWith('.')) {
          formatted += '0';
        }
      }
      
      return formatted;
    }

    function validateAmmo(ammoValue) {
      if (!ammoValue.trim()) return '';
      
      const num = parseInt(ammoValue);
      if (isNaN(num) || !Number.isInteger(parseFloat(ammoValue))) {
        throw new Error('Ammo must be a valid integer');
      }
      
      return num.toString();
    }

    function validateScalingValue(value, statName) {
      if (!value.trim()) return '';
      
      const num = parseInt(value);
      if (isNaN(num) || !Number.isInteger(parseFloat(value))) {
        throw new Error(`${statName} scaling value must be a valid integer`);
      }
      
      return num.toString();
    }

    function positionElementsRelativeToOnUse(content, onUseSection) {
      // Force a reflow to ensure all elements are properly measured
      content.offsetHeight;
      onUseSection.offsetHeight;
      
      // Get the position and dimensions relative to the content container
      const contentRect = content.getBoundingClientRect();
      const onUseRect = onUseSection.getBoundingClientRect();
      
      // Calculate the on-use section position relative to the content container
      const onUseRelativeTop = onUseSection.offsetTop;
      const onUseHeight = onUseSection.offsetHeight;
      const onUseCenterY = onUseRelativeTop + (onUseHeight / 2);
      
      // Position cooldown and ammo elements
      const cooldownSection = content.querySelector('.cooldown-section');
      const ammoSection = content.querySelector('.ammo-section');
      
      if (cooldownSection) {
        // Cooldown is 50px tall, so subtract 25px to center it
        cooldownSection.style.top = `${onUseCenterY - 25}px`;
      }
      
      if (ammoSection) {
        // Get the actual height of the ammo section and center it
        const ammoHeight = ammoSection.offsetHeight;
        ammoSection.style.top = `${onUseCenterY - (ammoHeight / 2)}px`;
      }
    }

    function clearAllCards() {
      const outputContainer = document.getElementById("outputContainer");
      outputContainer.innerHTML = '';
      cardsData = [];
    }

    function clearCard(cardElement) {
      const cardIndex = Array.from(cardElement.parentNode.children).indexOf(cardElement);
      cardsData.splice(cardIndex, 1);
      cardElement.remove();
    }

    // Export/Import Functions
    function exportAllCardsAsData() {
      if (cardsData.length === 0) {
        showMessage('No cards to export!', 'error');
        return;
      }

      const dataToExport = {
        version: "1.0",
        timestamp: new Date().toISOString(),
        cards: cardsData
      };

      const dataStr = JSON.stringify(dataToExport, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      
      const link = document.createElement('a');
      link.href = url;
      link.download = `Bazaar-cards-${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);

      showMessage(`Exported ${cardsData.length} cards successfully!`, 'success');
    }

    function exportAllCardsAsPNG() {
      const cards = document.querySelectorAll('.card');
      if (cards.length === 0) {
        showMessage('No cards to export!', 'error');
        return;
      }

      showMessage('Generating PNG files...', 'success');
      
      // Export each card sequentially to avoid overwhelming the browser
      let currentIndex = 0;
      
      function exportNextCard() {
        if (currentIndex >= cards.length) {
          showMessage(`All ${cards.length} cards exported as PNG!`, 'success');
          return;
        }
        
        const card = cards[currentIndex];
        exportCardAsPNG(card);
        currentIndex++;
        
        // Small delay between exports
        setTimeout(exportNextCard, 500);
      }
      
      exportNextCard();
    }

    function triggerImport() {
      document.getElementById('importInput').click();
    }

    function importCardData(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const importedData = JSON.parse(e.target.result);
          
          if (!importedData.cards || !Array.isArray(importedData.cards)) {
            throw new Error('Invalid file format');
          }

          let importedCount = 0;
          importedData.cards.forEach(cardData => {
            try {
              importSingleCard(cardData);
              importedCount++;
            } catch (error) {
              console.error('Error importing card:', error);
            }
          });

          if (importedCount > 0) {
            showMessage(`Successfully imported ${importedCount} cards!`, 'success');
          } else {
            showMessage('No cards could be imported from this file.', 'error');
          }

        } catch (error) {
          showMessage('Error reading file: ' + error.message, 'error');
        }
      };
      reader.readAsText(file);
      
      // Clear the input
      event.target.value = '';
    }

    function importSingleCard(cardData) {
      // Create a new card element based on the imported data
      const outputContainer = document.getElementById("outputContainer");
      const borderColor = getBorderColor(cardData.border);
      
      const card = document.createElement("div");
      card.className = "card";

      // Add delete and export buttons for individual card
      const cardControls = document.createElement("div");
      cardControls.className = "card-controls";
      
      const exportBtn = document.createElement("button");
      exportBtn.className = "card-export-btn";
      exportBtn.innerHTML = "💾";
      exportBtn.title = "Export this card";
      exportBtn.onclick = function() {
        toggleExportMenu(exportBtn, cardData);
      };

      // NEW: Save to Database button
      const saveBtn = document.createElement("button");
      saveBtn.className = "card-save-btn";
      saveBtn.innerHTML = "🗃️";
      saveBtn.title = "Save to database";
      saveBtn.onclick = function() {
        saveCardToDatabase(cardData);
      };

      
      const deleteBtn = document.createElement("button");
      deleteBtn.className = "card-delete-btn";
      deleteBtn.innerHTML = "×";
      deleteBtn.title = "Delete this card";
      deleteBtn.onclick = function() {
        clearCard(card);
      };
      
      cardControls.appendChild(exportBtn);
      cardControls.appendChild(saveBtn); 
      cardControls.appendChild(deleteBtn);
      card.appendChild(cardControls);

      const imageContainer = document.createElement("div");
      imageContainer.className = "image-container";
      imageContainer.style.border = `3px solid ${borderColor}`;

      // Create a clipping wrapper for the uploaded image
      const imageClipWrapper = document.createElement("div");
      imageClipWrapper.className = "image-clip-wrapper";

      const img = document.createElement("img");
      img.className = "uploaded-image";
      img.src = cardData.imageData; // Base64 image data
      imageClipWrapper.appendChild(img);
      imageContainer.appendChild(imageClipWrapper);

      // Add frame overlay (this will overflow)
      const frame = createFrameElement(cardData.border, cardData.itemSize);
      imageContainer.appendChild(frame);

      // Add scaling values if any exist
      if (cardData.scalingValues) {
        const scalingContainer = createScalingValuesContainer(cardData.scalingValues);
        if (scalingContainer.children.length > 0) {
          imageContainer.appendChild(scalingContainer);
        }
      }

      // Create tags container
      const tagsContainer = document.createElement("div");
      tagsContainer.className = "tags-container";

      // Add item size tag
      const itemSizeTag = document.createElement("span");
      itemSizeTag.className = "item-tag";
      itemSizeTag.textContent = cardData.itemSize;
      tagsContainer.appendChild(itemSizeTag);

      // Add additional tags
      cardData.tags.forEach(tagText => {
        const tag = document.createElement("span");
        tag.className = "item-tag";
        tag.textContent = tagText;
        tagsContainer.appendChild(tag);
      });

      const content = document.createElement("div");
      content.className = "card-content";
      content.style.border = `3px solid ${borderColor}`;

      // Top section with title and hero
      const topSection = document.createElement("div");
      topSection.className = "text-section hero-header";
      topSection.style.borderTop = `2px solid ${borderColor}`;
      topSection.style.borderBottom = `2px solid ${borderColor}`;
      const itemTitle = document.createElement("div");
      itemTitle.className = "item-title";
      itemTitle.textContent = cardData.itemName;
      const heroImg = document.createElement("img");
      heroImg.src = `images/${cardData.hero.toLowerCase()}.png`;
      heroImg.alt = cardData.hero;
      topSection.appendChild(itemTitle);
      topSection.appendChild(heroImg);
      content.appendChild(topSection);

      // On use effects
      let onUseSection = null;
      if (cardData.onUseEffects && cardData.onUseEffects.length > 0) {
        const effectsContainer = document.createElement("div");
        cardData.onUseEffects.forEach(effect => {
          const effectLine = document.createElement("div");
          effectLine.className = "on-use-line";

          const icon = document.createElement("img");
          icon.src = "images/use-arrow.png";
          icon.alt = "-";

          const text = document.createElement("span");
          text.innerHTML = processKeywordText(effect);

          effectLine.appendChild(icon);
          effectLine.appendChild(text);
          effectsContainer.appendChild(effectLine);
        });

        onUseSection = document.createElement("div");
        onUseSection.className = "text-section on-use-section";
        onUseSection.style.borderTop = `2px solid ${borderColor}`;
        onUseSection.style.borderBottom = `2px solid ${borderColor}`;
        onUseSection.appendChild(effectsContainer);
        content.appendChild(onUseSection);
      }

      // Passive effects
      if (cardData.passiveEffect && cardData.passiveEffect.trim()) {
        const passiveSection = document.createElement("div");
        passiveSection.className = "text-section";
        passiveSection.style.borderTop = `2px solid ${borderColor}`;
        passiveSection.style.borderBottom = `2px solid ${borderColor}`;
        passiveSection.innerHTML = processKeywordText(cardData.passiveEffect);
        content.appendChild(passiveSection);
      }

      // Cooldown
      if (cardData.cooldown && cardData.onUseEffects && cardData.onUseEffects.length > 0) {
        const cooldownDiv = document.createElement("div");
        cooldownDiv.className = "cooldown-section";
        cooldownDiv.innerHTML = `<span>${cardData.cooldown}</span><span class="sec-text">sec</span>`;
        
        // Add cooldown border overlay
        const cooldownBorder = createCooldownBorderElement(cardData.border);
        cooldownDiv.appendChild(cooldownBorder);
        
        content.appendChild(cooldownDiv);
      }

      // Ammo
      if (cardData.ammo) {
        const ammoDiv = document.createElement("div");
        ammoDiv.className = "ammo-section";
        ammoDiv.style.border = `3px solid ${borderColor}`;
        
        const ammoImg = document.createElement("img");
        ammoImg.src = "images/ammo.png";
        ammoImg.alt = "Ammo";
        ammoDiv.appendChild(ammoImg);
        
        const ammoText = document.createElement("span");
        ammoText.textContent = cardData.ammo;
        ammoDiv.appendChild(ammoText);
        
        content.appendChild(ammoDiv);
      }

      // Create wrapper and visual content container
      const cardWrapper = document.createElement("div");
      cardWrapper.className = "card-wrapper";
      cardWrapper.appendChild(tagsContainer);
      cardWrapper.appendChild(content);

      // Create the tight visual content container
      const visualContent = document.createElement("div");
      visualContent.className = "card-visual-content";
      visualContent.appendChild(imageContainer);
      visualContent.appendChild(cardWrapper);
      
      card.appendChild(visualContent);
      outputContainer.appendChild(card);

      // Add to cards data
      cardsData.push(cardData);

      // Set dimensions and positioning - Modified for fixed image height
      setTimeout(() => {
        // Image container now has fixed height of 150px and 35px top margin
        let widthRatio = 1.0;
        if (cardData.itemSize === "Small") {
          widthRatio = 0.5;
        } else if (cardData.itemSize === "Large") {
          widthRatio = 1.5;
        }

        const containerWidth = 150 * widthRatio; // Use fixed height instead of content height
        imageContainer.style.width = containerWidth + "px";

        img.style.height = "100%";
        img.style.width = "auto";
        img.style.objectFit = "cover";
        img.style.objectPosition = "center";

        if (onUseSection) {
          positionElementsRelativeToOnUse(content, onUseSection);
        }
      }, 0);
    }

    function toggleExportMenu(button, cardData) {
      // Close all other export menus
      document.querySelectorAll('.export-menu').forEach(menu => {
        if (menu.parentElement !== button.parentElement) {
          menu.classList.remove('show');
        }
      });

      let menu = button.parentElement.querySelector('.export-menu');
      if (!menu) {
        menu = document.createElement('div');
        menu.className = 'export-menu';
        
        const dataOption = document.createElement('div');
        dataOption.className = 'export-option';
        dataOption.textContent = 'Export as Data';
        dataOption.onclick = () => {
          exportSingleCardAsData(cardData);
          menu.classList.remove('show');
        };
        
        const pngOption = document.createElement('div');
        pngOption.className = 'export-option';
        pngOption.textContent = 'Save as PNG';
        pngOption.onclick = () => {
          exportCardAsPNG(button.closest('.card'));
          menu.classList.remove('show');
        };
        
        menu.appendChild(dataOption);
        menu.appendChild(pngOption);
        button.parentElement.appendChild(menu);
      }

      menu.classList.toggle('show');
    }

    function exportSingleCardAsData(cardData) {
      const dataToExport = {
        version: "1.0",
        timestamp: new Date().toISOString(),
        cards: [cardData]
      };

      const dataStr = JSON.stringify(dataToExport, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      
      const link = document.createElement('a');
      link.href = url;
      link.download = `${cardData.itemName.replace(/\s+/g, '-')}-card.json`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);

      showMessage('Card exported successfully!', 'success');
    }

    function exportCardAsPNG(cardElement) {
      // Find the visual content container
      const visualContent = cardElement.querySelector('.card-visual-content');
      
      if (!visualContent) {
        showMessage('Error: Card visual content not found', 'error');
        return;
      }
      
      // Find the card content element and temporarily change its background
      const cardContent = visualContent.querySelector('.card-content');
      let originalBackground = '';
      
      if (cardContent) {
        // Store original background and replace gradient with solid color
        originalBackground = cardContent.style.background;
        cardContent.style.setProperty('background', 'rgb(45, 35, 22)', 'important');
      }
      
      // Simple, clean capture approach
      html2canvas(visualContent, {
        scale: 2,
        backgroundColor: null, // Transparent background
        useCORS: true,
        allowTaint: true
      }).then(function(canvas) {
        // Restore original background after capture
        if (cardContent) {
          cardContent.style.background = originalBackground;
        }
        
        // Create a new canvas with watermark
        const finalCanvas = document.createElement('canvas');
        const ctx = finalCanvas.getContext('2d');
        
        // Set final canvas size (original + space for watermark)
        const watermarkHeight = 30;
        finalCanvas.width = canvas.width;
        finalCanvas.height = canvas.height + watermarkHeight;
        
        // Draw original card
        ctx.drawImage(canvas, 0, 0);
        
        // Add watermark text
        ctx.fillStyle = '#666666';
        ctx.font = '16px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('Created on BazaarGen.com', finalCanvas.width / 2, canvas.height + 20);
        
        // Create download link
        const itemName = cardElement.querySelector('.item-title')?.textContent || 'card';
        const fileName = `${itemName.replace(/\s+/g, '-')}-card.png`;
        
        const link = document.createElement('a');
        link.download = fileName;
        link.href = finalCanvas.toDataURL('image/png');
        link.click();
        
        showMessage('Card saved as PNG successfully!', 'success');
      }).catch(function(error) {
        // Restore original background on error too
        if (cardContent) {
          cardContent.style.background = originalBackground;
        }
        
        console.error('PNG Export Error:', error);
        showMessage('Error saving PNG: ' + error.message, 'error');
      });
    }

    function showMessage(message, type) {
      const errorContainer = document.getElementById("errorContainer");
      const messageDiv = document.createElement("div");
      messageDiv.className = type;
      messageDiv.textContent = message;
      
      // Clear previous messages
      errorContainer.innerHTML = '';
      errorContainer.appendChild(messageDiv);
      
      // Auto-remove success messages after 3 seconds
      if (type === 'success') {
        setTimeout(() => {
          if (messageDiv.parentElement) {
            messageDiv.remove();
          }
        }, 3000);
      }
    }

      function createCard(ispreview = false) {
      const imageInput = document.getElementById("imageInput");
      const itemName = document.getElementById("itemNameInput").value;
      const cooldownInput = document.getElementById("cooldownInput").value;
      const hero = document.getElementById("heroSelect").value;
      const ammo = document.getElementById("ammoInput").value;
      const itemSize = document.getElementById("itemSizeSelect").value;
      const border = document.getElementById("borderSelect").value;
      const onUseInputs = document.querySelectorAll("#onUseInputs input");
      const tagInputs = document.querySelectorAll("#tagInputs input");
      const passiveInput = document.getElementById("passiveInput").value;
      const outputContainer = document.getElementById("outputContainer");
      const errorContainer = document.getElementById("errorContainer");

      // Get scaling values
      const scalingValues = {
        heal: document.getElementById("healScalingInput").value,
        regen: document.getElementById("regenScalingInput").value,
        shield: document.getElementById("shieldScalingInput").value,
        damage: document.getElementById("damageScalingInput").value,
        poison: document.getElementById("poisonScalingInput").value,
        burn: document.getElementById("burnScalingInput").value
      };

      // Clear previous errors
      errorContainer.innerHTML = '';

      // Validate scaling values
      const validatedScalingValues = {};
      try {
        validatedScalingValues.heal = validateScalingValue(scalingValues.heal, 'Heal');
        validatedScalingValues.regen = validateScalingValue(scalingValues.regen, 'Regen');
        validatedScalingValues.shield = validateScalingValue(scalingValues.shield, 'Shield');
        validatedScalingValues.damage = validateScalingValue(scalingValues.damage, 'Damage');
        validatedScalingValues.poison = validateScalingValue(scalingValues.poison, 'Poison');
        validatedScalingValues.burn = validateScalingValue(scalingValues.burn, 'Burn');
      } catch (error) {
        const errorDiv = document.createElement("div");
        errorDiv.className = "error";
        errorDiv.textContent = error.message;
        errorContainer.appendChild(errorDiv);
        return;
      }

      // Check for on use effects
      const hasOnUseEffects = Array.from(onUseInputs).some(input => input.value.trim());
      const hasCooldown = cooldownInput.trim();

      // Validate cooldown and on use effects dependency
      if (hasOnUseEffects && !hasCooldown) {
        const errorDiv = document.createElement("div");
        errorDiv.className = "error";
        errorDiv.textContent = "On Use effects require a cooldown value";
        errorContainer.appendChild(errorDiv);
        return;
      }

      // Validate and format cooldown
      let formattedCooldown = '';
      if (cooldownInput.trim()) {
        try {
          formattedCooldown = formatCooldown(cooldownInput);
        } catch (error) {
          const errorDiv = document.createElement("div");
          errorDiv.className = "error";
          errorDiv.textContent = error.message;
          errorContainer.appendChild(errorDiv);
          return;
        }
      }

      // Validate ammo
      let validatedAmmo = '';
      if (ammo.trim()) {
        try {
          validatedAmmo = validateAmmo(ammo);
        } catch (error) {
          const errorDiv = document.createElement("div");
          errorDiv.className = "error";
          errorDiv.textContent = error.message;
          errorContainer.appendChild(errorDiv);
          return;
        }
      }

      if (imageInput.files && imageInput.files[0]) {
        const reader = new FileReader();

        reader.onload = function (e) {
          const imageData = e.target.result;
          
          // Create card data object for export/import
          const cardData = {
            itemName: itemName,
            hero: hero,
            cooldown: formattedCooldown,
            ammo: validatedAmmo,
            itemSize: itemSize,
            border: border,
            passiveEffect: passiveInput,
            onUseEffects: Array.from(onUseInputs).map(input => input.value.trim()).filter(val => val),
            tags: Array.from(tagInputs).map(input => input.value.trim()).filter(val => val),
            scalingValues: validatedScalingValues,
            imageData: imageData,
            timestamp: new Date().toISOString()
          };

          // Store card data
          cardsData.push(cardData);

          const borderColor = getBorderColor(border);
          const card = document.createElement("div");
          card.className = "card";

          // Add delete and export buttons for individual card
          const cardControls = document.createElement("div");
          cardControls.className = "card-controls";
          
          const exportBtn = document.createElement("button");
          exportBtn.className = "card-export-btn";
          exportBtn.innerHTML = "💾";
          exportBtn.title = "Export this card";
          exportBtn.onclick = function() {
            toggleExportMenu(exportBtn, cardData);
          };
          
          const saveBtn = document.createElement("button");
          saveBtn.className = "card-save-btn";
          saveBtn.innerHTML = "🗃️";
          saveBtn.title = "Save to database";
          saveBtn.onclick = function() {
            saveCardToDatabase(cardData);
          };
          
          const deleteBtn = document.createElement("button");
          deleteBtn.className = "card-delete-btn";
          deleteBtn.innerHTML = "×";
          deleteBtn.title = "Delete this card";
          deleteBtn.onclick = function() {
            clearCard(card);
          };
          
          cardControls.appendChild(exportBtn);
          cardControls.appendChild(saveBtn);
          cardControls.appendChild(deleteBtn);
          card.appendChild(cardControls);

          const imageContainer = document.createElement("div");
          imageContainer.className = "image-container";
          imageContainer.style.border = `3px solid ${borderColor}`;

          // Create a clipping wrapper for the uploaded image
          const imageClipWrapper = document.createElement("div");
          imageClipWrapper.className = "image-clip-wrapper";

          const img = document.createElement("img");
          img.className = "uploaded-image";
          img.src = imageData;
          imageClipWrapper.appendChild(img);
          imageContainer.appendChild(imageClipWrapper);

          // Add frame overlay (this will overflow)
          const frame = createFrameElement(border, itemSize);
          imageContainer.appendChild(frame);

          // Add scaling values if any exist
          const scalingContainer = createScalingValuesContainer(validatedScalingValues);
          if (scalingContainer.children.length > 0) {
            imageContainer.appendChild(scalingContainer);
          }

          // Create tags container (outside the main bordered content)
          const tagsContainer = document.createElement("div");
          tagsContainer.className = "tags-container";

          // Always add item size as first tag
          const itemSizeTag = document.createElement("span");
          itemSizeTag.className = "item-tag";
          itemSizeTag.textContent = itemSize;
          tagsContainer.appendChild(itemSizeTag);

          // Add additional tags
          tagInputs.forEach(input => {
            if (input.value.trim()) {
              const tag = document.createElement("span");
              tag.className = "item-tag";
              tag.textContent = input.value.trim();
              tagsContainer.appendChild(tag);
            }
          });

          const content = document.createElement("div");
          content.className = "card-content";
          content.style.border = `3px solid ${borderColor}`;

          const topSection = document.createElement("div");
          topSection.className = "text-section hero-header";
          topSection.style.borderTop = `2px solid ${borderColor}`;
          topSection.style.borderBottom = `2px solid ${borderColor}`;
          const itemTitle = document.createElement("div");
          itemTitle.className = "item-title";
          itemTitle.textContent = itemName;
          const heroImg = document.createElement("img");
          heroImg.src = `images/${hero.toLowerCase()}.png`;
          heroImg.alt = hero;
          topSection.appendChild(itemTitle);
          topSection.appendChild(heroImg);
          content.appendChild(topSection);

          let onUseSection = null;
          const effectsContainer = document.createElement("div");
          onUseInputs.forEach(input => {
            if (input.value.trim()) {
              const effectLine = document.createElement("div");
              effectLine.className = "on-use-line";

              const icon = document.createElement("img");
              icon.src = "images/use-arrow.png";
              icon.alt = "-";

              const text = document.createElement("span");
              text.innerHTML = processKeywordText(input.value);

              effectLine.appendChild(icon);
              effectLine.appendChild(text);
              effectsContainer.appendChild(effectLine);
            }
          });

          if (effectsContainer.children.length > 0) {
            onUseSection = document.createElement("div");
            onUseSection.className = "text-section on-use-section";
            onUseSection.style.borderTop = `2px solid ${borderColor}`;
            onUseSection.style.borderBottom = `2px solid ${borderColor}`;
            onUseSection.appendChild(effectsContainer);
            content.appendChild(onUseSection);
          }

          if (passiveInput.trim()) {
            const passiveSection = document.createElement("div");
            passiveSection.className = "text-section";
            passiveSection.style.borderTop = `2px solid ${borderColor}`;
            passiveSection.style.borderBottom = `2px solid ${borderColor}`;
            passiveSection.innerHTML = processKeywordText(passiveInput);
            content.appendChild(passiveSection);
          }

          // Only show cooldown if there are on use effects
          if (formattedCooldown && hasOnUseEffects) {
            const cooldownDiv = document.createElement("div");
            cooldownDiv.className = "cooldown-section";
            cooldownDiv.innerHTML = `<span>${formattedCooldown}</span><span class="sec-text">sec</span>`;
            
            // Add cooldown border overlay
            const cooldownBorder = createCooldownBorderElement(border);
            cooldownDiv.appendChild(cooldownBorder);
            
            content.appendChild(cooldownDiv);
          }

          if (validatedAmmo) {
            const ammoDiv = document.createElement("div");
            ammoDiv.className = "ammo-section";
            ammoDiv.style.border = `3px solid ${borderColor}`;
            
            // Add ammo image
            const ammoImg = document.createElement("img");
            ammoImg.src = "images/ammo.png";
            ammoImg.alt = "Ammo";
            ammoDiv.appendChild(ammoImg);
            
            // Add ammo number
            const ammoText = document.createElement("span");
            ammoText.textContent = validatedAmmo;
            ammoDiv.appendChild(ammoText);
            
            content.appendChild(ammoDiv);
          }

          // Create wrapper and visual content container
          const cardWrapper = document.createElement("div");
          cardWrapper.className = "card-wrapper";
          cardWrapper.appendChild(tagsContainer);
          cardWrapper.appendChild(content);

          // Create the tight visual content container
          const visualContent = document.createElement("div");
          visualContent.className = "card-visual-content";
          visualContent.appendChild(imageContainer);
          visualContent.appendChild(cardWrapper);
          
          card.appendChild(visualContent);
            outputContainer.appendChild(card);
            if (ispreview) {
                previewContainer.innerHTML = "";
                previewContainer.appendChild(card);
            }
            
          // Modified setTimeout for fixed image height and positioning
          setTimeout(() => {
            // Image container now has fixed height of 150px and 35px top margin (set in CSS)
            let widthRatio = 1.0; // Default to medium
            if (itemSize === "Small") {
              widthRatio = 0.5;
            } else if (itemSize === "Medium") {
              widthRatio = 1.0;
            } else if (itemSize === "Large") {
              widthRatio = 1.5;
            }

            const containerWidth = 150 * widthRatio; // Use fixed height of 150px instead of content height
            imageContainer.style.width = containerWidth + "px";

            img.style.height = "100%";
            img.style.width = "auto";
            img.style.objectFit = "cover";
            img.style.objectPosition = "center";

            // Position cooldown and ammo relative to the on-use section
            if (onUseSection) {
              positionElementsRelativeToOnUse(content, onUseSection);
            }
          }, 0);
        };

        reader.readAsDataURL(imageInput.files[0]);
      } else {
        const errorDiv = document.createElement("div");
        errorDiv.className = "error";
        errorDiv.textContent = "Please upload an image first.";
        errorContainer.appendChild(errorDiv);
      }
    }
//google single sign in functions 
   const SUPABASE_URL = 'https://zslsedcfihgwbfljqhod.supabase.co'
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpzbHNlZGNmaWhnd2JmbGpxaG9kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk4NTEwNzksImV4cCI6MjA2NTQyNzA3OX0.wA23SQZ8PZRambG4RVVWlcxUxdVUz4dNKLQgqY_xR08'

// Initialize Supabase client
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

let currentUser = null;
let isEditingAlias = false;
let currentUserData = null;

// Initialize Google Sign-In when the page loads
window.onload = function () {
    google.accounts.id.initialize({
        client_id: "208926605452-h7mj4nrcubf43pfi78vgql9o12lqnr0n.apps.googleusercontent.com",
        callback: handleCredentialResponse
    });
    
    // Render the sign-in button
    google.accounts.id.renderButton(
        document.getElementById("google-signin-button"),
        { 
            type: "standard",
            size: "medium", 
            theme: "outline",
            text: "sign_in_with",
            shape: "rectangular",
            logo_alignment: "left"
        }
    );

    // Check if user is already signed in to Supabase
    checkExistingSession();
};

// Google Sign-In Handler
async function handleCredentialResponse(response) {
    try {
        const responsePayload = decodeJwtResponse(response.credential);
        console.log("User signed in:", responsePayload.email);
        currentUser = responsePayload;

        // IMPORTANT: Sign in to Supabase with the Google credential
        const { data: supabaseUser, error: authError } = await supabase.auth.signInWithIdToken({
            provider: 'google',
            token: response.credential,
        });

        if (authError) {
            console.error('Supabase auth error:', authError);
            // Fallback: try with email/password or handle differently
        }

        // Rest of your existing code...
        const existingUser = await getUserFromDatabase(responsePayload.sub);
        
        if (existingUser) {
            currentUserData = existingUser;
            showUserInfo(existingUser.alias);
        } else {
            showAliasModal();
        }
    } catch (error) {
        console.error('Error handling sign-in:', error);
        alert('Sign-in failed. Please try again.');
    }
}

function decodeJwtResponse(token) {
    var base64Url = token.split('.')[1];
    var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join(''));
    return JSON.parse(jsonPayload);
}

function showAliasModal(isEditing = false) {
    const modal = document.getElementById('alias-modal');
    const input = document.getElementById('alias-input');
    const error = document.getElementById('alias-error');
    const title = document.getElementById('alias-modal-title');
    const description = document.getElementById('alias-modal-description');
    const saveBtn = document.getElementById('alias-save-btn');
    const cancelBtn = document.getElementById('alias-cancel-btn');
    
    isEditingAlias = isEditing;
    
    if (isEditing) {
        title.textContent = 'Edit Your Alias';
        description.textContent = 'Change your display name';
        input.value = currentUserData?.alias || '';
        saveBtn.textContent = 'Update Alias';
        cancelBtn.textContent = 'Cancel';
    } else {
        title.textContent = 'Welcome to BazaarGen!';
        description.textContent = 'Choose an alias to display on the site';
        input.value = '';
        saveBtn.textContent = 'Save Alias';
        cancelBtn.textContent = 'Cancel';
    }
    
    // Clear previous errors
    error.textContent = '';
    
    // Show modal
    modal.style.display = 'flex';
    
    // Focus on input
    setTimeout(() => input.focus(), 100);
    
    // Handle Enter key
    input.onkeypress = function(e) {
        if (e.key === 'Enter') {
            saveAlias();
        }
    }
}

async function saveAlias() {
    const input = document.getElementById('alias-input');
    const error = document.getElementById('alias-error');
    const alias = input.value.trim();
    
    // Clear previous errors
    error.textContent = '';
    
    // Simple validation
    if (!alias) {
        error.textContent = 'Please enter an alias';
        return;
    }
    
    if (alias.length < 2) {
        error.textContent = 'Alias must be at least 2 characters';
        return;
    }
    
    if (alias.length > 20) {
        error.textContent = 'Alias must be less than 20 characters';
        return;
    }

  //regex to specifically block emojis
      if (/[\u{1F600}-\u{1F64F}]|[\u{1F300}-\u{1F5FF}]|[\u{1F680}-\u{1F6FF}]|[\u{1F1E0}-\u{1F1FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/u.test(alias)) {
          error.textContent = 'Emojis are not allowed in aliases';
          return;
      }

    try {
        // Check if alias is already taken (skip check if editing and using same alias)
        if (!isEditingAlias || alias !== currentUserData?.alias) {
            const { data: existingAlias } = await supabase
                .from('users')
                .select('id')
                .eq('alias', alias)
                .maybeSingle();

            if (existingAlias) {
                error.textContent = 'Alias is already taken';
                return;
            }
        }

        let data, dbError;

        if (isEditingAlias) {
            // Update existing user - use ID instead of google_id to avoid duplicates
            const result = await supabase
                .from('users')
                .update({ alias: alias })
                .eq('id', currentUserData.id)
                .select()
                .single();
            
            data = result.data;
            dbError = result.error;
        } else {
            // Create new user - add ON CONFLICT handling
            const result = await supabase
                .from('users')
                .upsert([
                    {
                        google_id: currentUser.sub,
                        alias: alias,
                        email: currentUser.email,
                        avatar_url: currentUser.picture
                    }
                ], {
                    onConflict: 'google_id',
                    ignoreDuplicates: false
                })
                .select()
                .single();
            
            data = result.data;
            dbError = result.error;
        }

        if (dbError) {
            throw dbError;
        }

        // Success - hide modal and show user info
        document.getElementById('alias-modal').style.display = 'none';
        currentUserData = data;
        showUserInfo(alias);
        
        console.log('User saved to database:', data);
        
    } catch (error) {
        console.error('Error saving user:', error);
        error.textContent = 'Error saving alias. Please try again.';
    }
}

function cancelAliasCreation() {
    if (isEditingAlias) {
        // Just hide the modal when editing
        document.getElementById('alias-modal').style.display = 'none';
    } else {
        // Hide modal and sign out user for new user registration
        document.getElementById('alias-modal').style.display = 'none';
        signOut();
    }
}

function editAlias() {
    if (currentUserData) {
        showAliasModal(true);
    }
}

function showUserInfo(alias) {
    // Hide sign-in button
    document.getElementById('google-signin-button').style.display = 'none';
    
    // Show user info with alias
    const userInfo = document.getElementById('user-info');
    const userAlias = document.getElementById('user-alias');
    
    userAlias.textContent = alias;
    userInfo.style.display = 'flex';
}

async function signOut() {
    // Clear Google session
    google.accounts.id.disableAutoSelect();
    currentUser = null;
    
    // Hide user info and show sign-in button
    document.getElementById('user-info').style.display = 'none';
    document.getElementById('google-signin-button').style.display = 'block';
    
    console.log('User signed out');
}

// Database functions using Supabase (now with RLS)
async function getUserFromDatabase(googleId) {
    try {
        const { data, error } = await supabase
            .from('users')
            .select('*')
            .eq('google_id', googleId)
            .maybeSingle();

        if (error) {
            throw error;
        }

        return data;
    } catch (error) {
        console.error('Error getting user:', error);
        return null;
    }
}

async function checkExistingSession() {
    // For now, just rely on Google's session management
    // We can add Supabase session handling later
}

// Listen for auth state changes
supabase.auth.onAuthStateChange((event, session) => {
    console.log('Auth state changed:', event, session);
    
    if (event === 'SIGNED_OUT') {
        // Handle sign out
        document.getElementById('user-info').style.display = 'none';
        document.getElementById('google-signin-button').style.display = 'block';
    }
});

    async function debugAuth() {
    const { data: { session } } = await supabase.auth.getSession();
    console.log('Session:', session);
    console.log('User ID:', session?.user?.id);
    console.log('Google User:', currentUser);
}

    //save card to database
   async function saveCardToDatabase(cardData) {
     await debugAuth();
    try {
        // Check if user is signed in to Google
        if (!currentUser) {
            showMessage('Please sign in to save items to the database', 'error');
            return;
        }

        // Get current Supabase session
        const { data: { session }, error: sessionError } = await supabase.auth.getSession();
        
        if (sessionError) {
            console.error('Session check error:', sessionError);
            showMessage('Authentication error. Please try signing in again.', 'error');
            return;
        }
        
        if (!session || !session.user) {
            console.warn('No active Supabase session');
            showMessage('Please sign in to save items.', 'error');
            return;
        }

        console.log('Supabase session active:', {
            user_id: session.user.id,
            email: session.user.email,
            google_id: currentUser.sub
        });

        // Find the save button to show loading state
        const saveButtons = document.querySelectorAll('.card-save-btn');
        const saveButton = Array.from(saveButtons).find(btn => 
            btn.onclick.toString().includes(cardData.timestamp)
        );

        if (saveButton) {
            saveButton.disabled = true;
            saveButton.innerHTML = '⏳';
            saveButton.title = 'Saving...';
        }

        // Prepare the item data for database
        const itemToSave = {
            user_id: session.user.id,           // Supabase auth user ID
            user_google_id: currentUser.sub,    // Google ID for backward compatibility
            contest_number: 0,
            item_data: {
                name: cardData.itemName,
                hero: cardData.hero,
                item_size: cardData.itemSize,
                rarity: cardData.border,
                cooldown: cardData.cooldown || null,
                ammo: cardData.ammo || null,
                passive_effect: cardData.passiveEffect || null,
                on_use_effects: cardData.onUseEffects || [],
                tags: cardData.tags || [],
                scaling_values: cardData.scalingValues || {},
                image_data: cardData.imageData,
                created_with: "BazaarGen",
                version: "1.0"
            }
        };

        console.log('Attempting to save item:', {
            supabase_user_id: session.user.id,
            google_id: currentUser.sub,
            item_name: cardData.itemName
        });

        // Save to Supabase
        const { data, error } = await supabase
            .from('items')
            .insert([itemToSave])
            .select()
            .single();

        if (error) {
            console.error('Database insert error details:', {
                code: error.code,
                message: error.message,
                details: error.details,
                hint: error.hint
            });
            throw error;
        }

        // Success!
        showMessage(`"${cardData.itemName}" saved to database successfully!`, 'success');
        console.log('Item saved to database:', data);

        // Update button to show success
        if (saveButton) {
            saveButton.innerHTML = '✅';
            saveButton.title = 'Saved to database';
            saveButton.style.background = 'linear-gradient(135deg, rgb(46, 125, 50) 0%, rgb(27, 94, 32) 100%)';
            
            setTimeout(() => {
                saveButton.disabled = false;
                saveButton.innerHTML = '🗃️';
                saveButton.title = 'Save to database';
                saveButton.style.background = '';
            }, 2000);
        }

    } catch (error) {
        console.error('Error saving item to database:', error);
        
        let errorMessage = 'Failed to save item to database. ';
        if (error.code === '42501') {
            errorMessage += 'Permission denied. Check your database policies.';
        } else if (error.code === '23505') {
            errorMessage += 'This item may already exist.';
        } else if (error.message?.includes('column') && error.message?.includes('does not exist')) {
            errorMessage += 'Database schema mismatch. Please contact support.';
        } else {
            errorMessage += `Error: ${error.message || 'Unknown error'}`;
        }
        
        showMessage(errorMessage, 'error');

        // Reset button on error
        const saveButtons = document.querySelectorAll('.card-save-btn');
        const saveButton = Array.from(saveButtons).find(btn => btn.disabled);
        if (saveButton) {
            saveButton.disabled = false;
            saveButton.innerHTML = '🗃️';
            saveButton.title = 'Save to database';
            saveButton.style.background = '';
        }
    }
}
// Also add this helper function to get a better button reference
function createSaveButton(cardData) {
    const saveBtn = document.createElement("button");
    saveBtn.className = "card-save-btn";
    saveBtn.innerHTML = "🗃️";
    saveBtn.title = "Save to database";
    saveBtn.setAttribute('data-timestamp', cardData.timestamp); // Add unique identifier
    saveBtn.onclick = function() {
        saveCardToDatabase(cardData);
    };
    return saveBtn;
}


      document.addEventListener('DOMContentLoaded', function () {
          // Attach createCard to all input, select, and textarea elements
          document.querySelectorAll('input, select, textarea').forEach(function (el) {
              let eventType = (el.tagName.toLowerCase() === 'select') ? 'change' : 'input';
              el.addEventListener(eventType, createCard);
          });
      });


    
  </script>
</body>
</html>
